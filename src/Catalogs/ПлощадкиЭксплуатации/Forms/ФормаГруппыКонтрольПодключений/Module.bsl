
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
        ЭтотОбъект.ПоложениеКоманднойПанели = ПоложениеКоманднойПанелиФормы.Нет;
        ЭтотОбъект.Элементы.Наименование.Видимость = Ложь;
        ЭтотОбъект.Элементы.ГруппаКоманднаяПанельНастройкиПоУмолчанию.Видимость = Истина;
        ЭтотОбъект.Элементы.ЗаписатьИЗАкрытьМоя.КнопкаПоУмолчанию = Истина;
    КонецЕсли;
    
    ЗаполнитьНастройкиПоУмолчанию();
    
КонецПроцедуры

&НаСервере
Процедура ПриЗаписиНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
    ЗаписатьНастройкиПоУмолчанию();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаписатьИЗакрытьМоя(Команда)
    
    ЗаписатьНастройкиПоУмолчанию();
    ЭтотОбъект.Закрыть();
    
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьМоя(Команда)
    ЗаписатьНастройкиПоУмолчанию();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьНастройкиПоУмолчанию()

    Настройки = РегистрыСведений.НастройкиКонтрольПодключений.ПрочитатьНастройки(Справочники.ВидыКонтрольныхПроцедур.КонтрольПодключений());
    
    ЭтотОбъект.ЛогинПриПодключении = Настройки.ЛогинПриПодключении;
    ЭтотОбъект.ПарольПриПодключении = Настройки.ПарольПриПодключении;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "МеханизмПроверкиОбрабатыватьИзменения";
    НовСтрока.ПараметрПредставление = "Способ подключения";
    НовСтрока.ПараметрЗначение = Настройки.МеханизмПроверкиОбрабатыватьИзменения;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "URLОпубликованнойИнформационнойБазы";
    НовСтрока.ПараметрПредставление = "Строка соединения";
    Если Настройки.МеханизмПроверкиОбрабатыватьИзменения = Перечисления.МеханизмыПроверкиПодключения.WEBСервис Тогда 
        НовСтрока.ПараметрЗначение = Настройки.URLОпубликованнойИнформационнойБазы;
    ИначеЕсли Настройки.МеханизмПроверкиОбрабатыватьИзменения = Перечисления.МеханизмыПроверкиПодключения.COMСоединитель Тогда
        НовСтрока.ПараметрЗначение = Настройки.СтрокаСоединения;
    Иначе
        НовСтрока.ПараметрЗначение = Настройки.URLОпубликованнойИнформационнойБазы;
    КонецЕсли;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "Таймаут";
    НовСтрока.ПараметрПредставление = "Таймаут";
    НовСтрока.ПараметрЗначение = Настройки.Таймаут;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "ИспользоватьПрокси";
    НовСтрока.ПараметрПредставление = "Использовать прокси";
    НовСтрока.ПараметрЗначение = Настройки.ИспользоватьПрокси;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "ПроксиСервер";
    НовСтрока.ПараметрПредставление = "Сервер прокси";
    НовСтрока.ПараметрЗначение = Настройки.ПроксиСервер;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "ПроксиПорт";
    НовСтрока.ПараметрПредставление = "Порт прокси сервера";
    НовСтрока.ПараметрЗначение = Настройки.ПроксиПорт;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "ПериодКонтроля";
    НовСтрока.ПараметрПредставление = "Период контроля, сек.";
    НовСтрока.ПараметрЗначение = Настройки.ПериодКонтроля;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "МинимальныйПроцентДоступности";
    НовСтрока.ПараметрПредставление = "Минимальная доступность, %";
    НовСтрока.ПараметрЗначение = Настройки.МинимальныйПроцентДоступности;
    
    НовСтрока = ПараметрыПоУмолчанию.Добавить();
    НовСтрока.Параметр = "ДопустимоНетДанных";
    НовСтрока.ПараметрПредставление = "Допустимо нет данных, сек.";
    НовСтрока.ПараметрЗначение = Настройки.ДопустимоНетДанных;
    
КонецПроцедуры

&НаСервере
Процедура ЗаписатьНастройкиПоУмолчанию()
    
    Настройки = Новый Структура;
    
    Для Каждого ТекПараметр Из ПараметрыПоУмолчанию Цикл
        
        Если ТекПараметр.Параметр <> "URLОпубликованнойИнформационнойБазы" Тогда
            Настройки.Вставить(ТекПараметр.Параметр, ТекПараметр.ПараметрЗначение);
        Иначе
            URLОпубликованнойИнформационнойБазы = ТекПараметр.ПараметрЗначение;
        КонецЕсли;
        
        Если ТекПараметр.Параметр = "МеханизмПроверкиОбрабатыватьИзменения" Тогда
            МеханизмПроверкиОбрабатыватьИзменения = ТекПараметр.ПараметрЗначение;
        КонецЕсли;
        
    КонецЦикла;
    
    Если МеханизмПроверкиОбрабатыватьИзменения = Перечисления.МеханизмыПроверкиПодключения.WEBСервис Тогда
        Настройки.Вставить("URLОпубликованнойИнформационнойБазы", URLОпубликованнойИнформационнойБазы);
        Настройки.Вставить("СтрокаСоединения", "");
    ИначеЕсли МеханизмПроверкиОбрабатыватьИзменения = Перечисления.МеханизмыПроверкиПодключения.COMСоединитель Тогда
        Настройки.Вставить("URLОпубликованнойИнформационнойБазы", "");
        Настройки.Вставить("СтрокаСоединения", URLОпубликованнойИнформационнойБазы);
    Иначе
        Настройки.Вставить("URLОпубликованнойИнформационнойБазы", URLОпубликованнойИнформационнойБазы);
        Настройки.Вставить("СтрокаСоединения", "");
    КонецЕсли;
        
    Настройки.Вставить("ЛогинПриПодключении", ЭтотОбъект.ЛогинПриПодключении);
    Настройки.Вставить("ПарольПриПодключении", ЭтотОбъект.ПарольПриПодключении);
    
    РегистрыСведений.НастройкиКонтрольПодключений.ЗаписатьНастройки(Справочники.ВидыКонтрольныхПроцедур.КонтрольПодключений(), Настройки);
    
КонецПроцедуры

#КонецОбласти